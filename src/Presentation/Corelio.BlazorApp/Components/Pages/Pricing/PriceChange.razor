@page "/pricing"
@using System.Globalization
@using Corelio.BlazorApp.Components.Shared
@attribute [Authorize]
@inject IPricingService PricingService
@inject IProductService ProductService
@inject IStringLocalizer<SharedResource> L
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>@L["PriceChange"] - Corelio</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-6">
        <!-- Page Header -->
        <PageHeader Title="@L["PriceChange"]"
                    Description="@L["PriceChangeDescription"]"
                    Breadcrumbs="@_breadcrumbs">
            <Actions>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.PriceChange"
                           Disabled="@(!_selectedProducts.Any())"
                           OnClick="OpenBulkDialog">
                    @L["BulkPriceChange"]
                </MudButton>
            </Actions>
        </PageHeader>

        <!-- Filters -->
        <MudPaper Elevation="0" Class="pa-4 mb-4 bg-light" Style="border-radius: var(--mud-default-borderradius);">
            <MudGrid Spacing="2">
                <MudItem xs="12" md="5">
                    <MudTextField @bind-Value="_searchTerm"
                                  Label="@L["Search"]"
                                  Placeholder="@L["SearchByNameOrSku"]"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  OnAdornmentClick="LoadProducts"
                                  OnKeyUp="@(async (e) => { if (e.Key == "Enter") await LoadProducts(); })"
                                  Immediate="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect @bind-Value="_selectedCategoryId"
                               Label="@L["Category"]"
                               Variant="Variant.Outlined"
                               Clearable="true"
                               Placeholder="@L["AllCategories"]">
                        @foreach (var category in _categories)
                        {
                            <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="2" Class="d-flex align-end">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Search"
                               OnClick="LoadProducts">
                        @L["Search"]
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Selection toolbar -->
        @if (_selectedProducts.Any())
        {
            <MudPaper Elevation="0" Class="pa-3 mb-4" Style="background-color: var(--mud-palette-primary-lighten); border-radius: var(--mud-default-borderradius);">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.body2">
                        <strong>@_selectedProducts.Count</strong> @L["ProductsSelected"]
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.PriceChange"
                               OnClick="OpenBulkDialog">
                        @L["BulkPriceChange"]
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        <!-- Products Table -->
        @if (_loading)
        {
            <LoadingState Message="@L["Loading"]" />
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }
        else if (_products is not null && _products.Any())
        {
            <MudTable Items="@_products"
                      Hover="true"
                      Dense="true"
                      Striped="true"
                      MultiSelection="true"
                      @bind-SelectedItems="_selectedProducts"
                      T="ProductPricingModel">
                <HeaderContent>
                    <MudTh>@L["SKU"]</MudTh>
                    <MudTh>@L["ProductName"]</MudTh>
                    <MudTh Style="text-align: right;">@L["ListPrice"]</MudTh>
                    <MudTh Style="text-align: right;">@L["NetCost"]</MudTh>
                    @if (_tenantConfig is not null)
                    {
                        @foreach (var tier in _tenantConfig.MarginTiers.Where(t => t.IsActive))
                        {
                            <MudTh Style="text-align: right;">@tier.TierName</MudTh>
                        }
                    }
                    <MudTh Style="text-align: center;">@L["Actions"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="@L["SKU"]">@context.Sku</MudTd>
                    <MudTd DataLabel="@L["ProductName"]">
                        <MudText Typo="Typo.body2"><strong>@context.ProductName</strong></MudText>
                    </MudTd>
                    <MudTd DataLabel="@L["ListPrice"]" Style="text-align: right;">
                        @FormatCurrency(context.ListPrice)
                    </MudTd>
                    <MudTd DataLabel="@L["NetCost"]" Style="text-align: right;">
                        @FormatCurrency(context.NetCost)
                    </MudTd>
                    @if (_tenantConfig is not null)
                    {
                        @foreach (var tier in _tenantConfig.MarginTiers.Where(t => t.IsActive))
                        {
                            var marginPrice = context.MarginPrices.FirstOrDefault(m => m.TierNumber == tier.TierNumber);
                            <MudTd Style="text-align: right;">
                                @if (marginPrice?.SalePrice is not null)
                                {
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2">@FormatCurrency(marginPrice.SalePrice)</MudText>
                                        @if (marginPrice.MarginPercentage.HasValue)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@marginPrice.MarginPercentage.Value.ToString("N1")%</MudText>
                                        }
                                    </MudStack>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                                }
                            </MudTd>
                        }
                    }
                    <MudTd DataLabel="@L["Actions"]" Style="text-align: center;">
                        @if (_editingProductId == context.ProductId)
                        {
                            <MudStack Row="true" Spacing="1" Justify="Justify.Center">
                                <MudIconButton Icon="@Icons.Material.Filled.Save"
                                               Color="Color.Success"
                                               Size="Size.Small"
                                               OnClick="SaveInlineEdit" />
                                <MudIconButton Icon="@Icons.Material.Filled.Close"
                                               Color="Color.Default"
                                               Size="Size.Small"
                                               OnClick="CancelInlineEdit" />
                            </MudStack>
                        }
                        else
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => StartInlineEdit(context))" />
                        }
                    </MudTd>
                </RowTemplate>
                <ChildRowContent>
                    @if (_editingProductId == context.ProductId)
                    {
                        <MudTr>
                            <td colspan="100" class="pa-4" style="background-color: var(--mud-palette-background-grey);">
                                <ProductCostos ListPrice="_editListPrice"
                                               ListPriceChanged="@((val) => _editListPrice = val)"
                                               IvaEnabled="_editIvaEnabled"
                                               IvaEnabledChanged="@((val) => _editIvaEnabled = val)"
                                               Discounts="_editDiscounts"
                                               DiscountsChanged="@((val) => _editDiscounts = val)"
                                               MarginPrices="_editMarginPrices"
                                               MarginPricesChanged="@((val) => _editMarginPrices = val)"
                                               IvaPercentage="_ivaPercentage" />

                                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Class="mt-3">
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Secondary"
                                               Size="Size.Small"
                                               OnClick="CancelInlineEdit">
                                        @L["Cancel"]
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               Disabled="_savingInline"
                                               OnClick="SaveInlineEdit">
                                        @if (_savingInline)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                            <MudText Class="ms-2">@L["Saving"]</MudText>
                                        }
                                        else
                                        {
                                            @L["Save"]
                                        }
                                    </MudButton>
                                </MudStack>
                            </td>
                        </MudTr>
                    }
                </ChildRowContent>
            </MudTable>

            <!-- Pagination -->
            @if (_pagedResult is not null)
            {
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-4">
                    <MudText Typo="Typo.body2">
                        @L["ShowingResults"] @_pagedResult.Items.Count @L["Of"] @_pagedResult.TotalCount @L["Products"]
                    </MudText>
                    <MudPagination Count="@_pagedResult.TotalPages"
                                   Selected="@_pagedResult.PageNumber"
                                   SelectedChanged="@(async (page) => { _currentPage = page; await LoadProducts(); })"
                                   BoundaryCount="1"
                                   MiddleCount="3"
                                   Color="Color.Primary" />
                </MudStack>
            }
        }
        else
        {
            <EmptyState Icon="@Icons.Material.Filled.PriceChange"
                        Title="@L["NoProductPricingFound"]"
                        Description="@L["NoProductPricingDescription"]" />
        }
    </MudPaper>
</MudContainer>

@code {
    private bool _loading = true;
    private string? _errorMessage;
    private List<ProductPricingModel> _products = [];
    private List<ProductCategoryDto> _categories = [];
    private HashSet<ProductPricingModel> _selectedProducts = [];
    private PagedResult<ProductPricingModel>? _pagedResult;
    private TenantPricingConfigModel? _tenantConfig;

    // Filters
    private string? _searchTerm;
    private Guid? _selectedCategoryId;
    private int _currentPage = 1;
    private int _pageSize = 20;

    // Inline edit state
    private Guid? _editingProductId;
    private decimal? _editListPrice;
    private bool _editIvaEnabled;
    private List<ProductDiscountEditModel> _editDiscounts = [];
    private List<ProductMarginPriceEditModel> _editMarginPrices = [];
    private decimal _ivaPercentage = 16m;
    private bool _savingInline;

    // Breadcrumbs
    private List<BreadcrumbItem> _breadcrumbs = [];

    protected override async Task OnInitializedAsync()
    {
        _breadcrumbs =
        [
            new BreadcrumbItem(L["Home"], "/"),
            new BreadcrumbItem(L["PriceChange"], null, disabled: true)
        ];

        await LoadTenantConfig();
        await LoadCategories();
        await LoadProducts();
    }

    private async Task LoadTenantConfig()
    {
        var result = await PricingService.GetTenantConfigAsync();
        if (result.IsSuccess && result.Value is not null)
        {
            _tenantConfig = result.Value;
            _ivaPercentage = _tenantConfig.IvaPercentage;
        }
    }

    private async Task LoadCategories()
    {
        var result = await ProductService.GetCategoriesAsync();
        if (result.IsSuccess && result.Value is not null)
        {
            _categories = result.Value;
        }
    }

    private async Task LoadProducts()
    {
        _loading = true;
        _errorMessage = null;
        _editingProductId = null;

        try
        {
            var result = await PricingService.GetProductsPricingAsync(
                _currentPage,
                _pageSize,
                _searchTerm,
                _selectedCategoryId);

            if (result.IsSuccess && result.Value is not null)
            {
                _pagedResult = result.Value;
                _products = _pagedResult.Items;
            }
            else
            {
                _errorMessage = result.Error ?? L["ErrorLoadingPricing"];
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"{L["Error"]}: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private void StartInlineEdit(ProductPricingModel product)
    {
        _editingProductId = product.ProductId;
        _editListPrice = product.ListPrice;
        _editIvaEnabled = product.IvaEnabled;

        _editDiscounts = product.Discounts
            .Select(ProductDiscountEditModel.FromRecord)
            .ToList();

        _editMarginPrices = product.MarginPrices
            .Select(ProductMarginPriceEditModel.FromRecord)
            .ToList();

        // Fill missing tiers from tenant config
        if (_tenantConfig is not null)
        {
            foreach (var tier in _tenantConfig.DiscountTiers.Where(t => t.IsActive))
            {
                if (!_editDiscounts.Any(d => d.TierNumber == tier.TierNumber))
                {
                    _editDiscounts.Add(new ProductDiscountEditModel
                    {
                        TierNumber = tier.TierNumber,
                        TierName = tier.TierName,
                        DiscountPercentage = 0
                    });
                }
            }

            foreach (var tier in _tenantConfig.MarginTiers.Where(t => t.IsActive))
            {
                if (!_editMarginPrices.Any(m => m.TierNumber == tier.TierNumber))
                {
                    _editMarginPrices.Add(new ProductMarginPriceEditModel
                    {
                        TierNumber = tier.TierNumber,
                        TierName = tier.TierName
                    });
                }
            }

            _editDiscounts = [.. _editDiscounts.OrderBy(d => d.TierNumber)];
            _editMarginPrices = [.. _editMarginPrices.OrderBy(m => m.TierNumber)];
        }
    }

    private void CancelInlineEdit()
    {
        _editingProductId = null;
    }

    private async Task SaveInlineEdit()
    {
        if (!_editingProductId.HasValue)
        {
            return;
        }

        _savingInline = true;

        try
        {
            var discounts = _editDiscounts.Select(d => d.ToRecord()).ToList();
            var marginPrices = _editMarginPrices.Select(m => m.ToRecord()).ToList();

            var result = await PricingService.UpdateProductPricingAsync(
                _editingProductId.Value,
                _editListPrice,
                _editIvaEnabled,
                discounts,
                marginPrices);

            if (result.IsSuccess)
            {
                Snackbar.Add(L["ProductPricingUpdated"], Severity.Success);
                _editingProductId = null;
                await LoadProducts();
            }
            else
            {
                Snackbar.Add(result.Error ?? L["ProductPricingUpdateFailed"], Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Error"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingInline = false;
        }
    }

    private async Task OpenBulkDialog()
    {
        if (!_selectedProducts.Any())
        {
            return;
        }

        var parameters = new DialogParameters
        {
            { nameof(BulkPriceChangeDialog.SelectedProducts), _selectedProducts.ToList() },
            { nameof(BulkPriceChangeDialog.TenantConfig), _tenantConfig }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<BulkPriceChangeDialog>(
            L["BulkPriceChangeTitle"], parameters, options);

        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            _selectedProducts.Clear();
            await LoadProducts();
        }
    }

    private static string FormatCurrency(decimal? value)
    {
        if (!value.HasValue)
        {
            return "-";
        }

        return value.Value.ToString("C", new CultureInfo("es-MX"));
    }
}
