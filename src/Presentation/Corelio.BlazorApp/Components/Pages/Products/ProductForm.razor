@page "/products/new"
@page "/products/{Id:guid}"
@using System.Globalization
@using Corelio.BlazorApp.Components.Shared
@attribute [Authorize]
@inject IProductService ProductService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L
@inject ISnackbar Snackbar

<PageTitle>@(_isEditMode ? L["EditProduct"] : L["AddProduct"]) - Corelio</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-6">
        <!-- Page Header with Breadcrumbs -->
        <PageHeader Title="@(_isEditMode ? L["EditProduct"] : L["NewProduct"])"
                    Breadcrumbs="@_breadcrumbs">
            <Actions>
                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => NavigationManager.NavigateTo("/products"))">
                    @L["Back"]
                </MudButton>
            </Actions>
        </PageHeader>

        @if (_loading)
        {
            <LoadingState Message="@L["Loading"]" />
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }
        else
        {
            <EditForm Model="_product" OnValidSubmit="HandleSubmit">
                <MudStack Spacing="4">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <MudText Typo="Typo.h6" Class="form-section-title">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" Size="Size.Small" />
                            @L["BasicInformation"]
                        </MudText>
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_product.Sku"
                                              Label="@L["SKU"]"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              RequiredError="@L["SKURequired"]" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_product.Barcode"
                                              Label="@L["Barcode"]"
                                              Variant="Variant.Outlined" />
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField @bind-Value="_product.Name"
                                              Label="@L["ProductName"]"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              RequiredError="@L["ProductNameRequired"]" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudSelect @bind-Value="_product.CategoryId"
                                           Label="@L["Category"]"
                                           Variant="Variant.Outlined"
                                           Clearable="true"
                                           Placeholder="@L["SelectCategory"]">
                                    @foreach (var category in _categories)
                                    {
                                        <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_product.Brand"
                                              Label="@L["Brand"]"
                                              Variant="Variant.Outlined" />
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField @bind-Value="_product.Description"
                                              Label="@L["Description"]"
                                              Variant="Variant.Outlined"
                                              Lines="3" />
                            </MudItem>
                        </MudGrid>
                    </div>

                    <!-- Pricing Section -->
                    <div class="form-section">
                        <MudText Typo="Typo.h6" Class="form-section-title">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" Size="Size.Small" />
                            @L["PricingSection"]
                        </MudText>
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_product.CostPrice"
                                                 Label="@L["CostPrice"]"
                                                 Variant="Variant.Outlined"
                                                 Format="C"
                                                 Culture="@(new CultureInfo("es-MX"))"
                                                 Min="0m"
                                                 T="decimal" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_product.SalePrice"
                                                 Label="@L["SalePrice"]"
                                                 Variant="Variant.Outlined"
                                                 Format="C"
                                                 Culture="@(new CultureInfo("es-MX"))"
                                                 Required="true"
                                                 RequiredError="@L["PriceRequired"]"
                                                 Min="0.01m"
                                                 T="decimal" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_product.TaxRate"
                                                 Label="@L["TaxRate"]"
                                                 Variant="Variant.Outlined"
                                                 Format="P2"
                                                 Min="0m"
                                                 Max="1m"
                                                 Step="0.01m"
                                                 T="decimal"
                                                 HelperText="IVA (0.16 = 16%)" />
                            </MudItem>
                        </MudGrid>
                    </div>

                    <!-- Inventory Section -->
                    <div class="form-section">
                        <MudText Typo="Typo.h6" Class="form-section-title">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2" Size="Size.Small" />
                            @L["InventorySection"]
                        </MudText>
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudSelect @bind-Value="_product.UnitOfMeasure"
                                           Label="@L["UnitOfMeasure"]"
                                           Variant="Variant.Outlined"
                                           Required="true">
                                    <MudSelectItem Value="@("PCS")">@L["UnitPieces"]</MudSelectItem>
                                    <MudSelectItem Value="@("KG")">@L["UnitKilograms"]</MudSelectItem>
                                    <MudSelectItem Value="@("M")">@L["UnitMeters"]</MudSelectItem>
                                    <MudSelectItem Value="@("L")">@L["UnitLiters"]</MudSelectItem>
                                    <MudSelectItem Value="@("BOX")">@L["UnitBoxes"]</MudSelectItem>
                                    <MudSelectItem Value="@("PACK")">@L["UnitPacks"]</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" md="6" Class="d-flex align-center">
                                <MudSwitch @bind-Value="_product.TrackInventory"
                                           Label="@L["TrackInventory"]"
                                           Color="Color.Primary" />
                            </MudItem>

                            @if (_product.TrackInventory)
                            {
                                <MudItem xs="12" md="6">
                                    <MudNumericField @bind-Value="_product.MinStockLevel"
                                                     Label="@L["MinStockLevel"]"
                                                     Variant="Variant.Outlined"
                                                     Min="0m"
                                                     T="decimal" />
                                </MudItem>
                            }
                        </MudGrid>
                    </div>

                    <!-- Status Section -->
                    <div class="form-section">
                        <MudText Typo="Typo.h6" Class="form-section-title">
                            <MudIcon Icon="@Icons.Material.Filled.Tune" Class="mr-2" Size="Size.Small" />
                            @L["StatusSection"]
                        </MudText>
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudSwitch @bind-Value="_product.IsActive"
                                           Label="@L["Active"]"
                                           Color="Color.Success" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudSwitch @bind-Value="_product.IsFeatured"
                                           Label="@L["Featured"]"
                                           Color="Color.Warning" />
                            </MudItem>
                        </MudGrid>
                    </div>

                    <!-- Actions -->
                    <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Class="mt-4">
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   OnClick="@(() => NavigationManager.NavigateTo("/products"))">
                            @L["Cancel"]
                        </MudButton>
                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_saving">
                            @if (_saving)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">@L["Saving"]</MudText>
                            }
                            else
                            {
                                @L["Save"]
                            }
                        </MudButton>
                    </MudStack>
                </MudStack>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private bool _isEditMode => Id.HasValue;
    private bool _loading = true;
    private bool _saving;
    private string? _errorMessage;
    private CreateProductRequest _product = new();
    private List<ProductCategoryDto> _categories = [];

    // Breadcrumbs
    private List<BreadcrumbItem> _breadcrumbs = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();

        if (_isEditMode && Id.HasValue)
        {
            _breadcrumbs =
            [
                new BreadcrumbItem(L["Home"], "/"),
                new BreadcrumbItem(L["Products"], "/products"),
                new BreadcrumbItem(L["EditProduct"], null, disabled: true)
            ];
            await LoadProduct(Id.Value);
        }
        else
        {
            _breadcrumbs =
            [
                new BreadcrumbItem(L["Home"], "/"),
                new BreadcrumbItem(L["Products"], "/products"),
                new BreadcrumbItem(L["NewProduct"], null, disabled: true)
            ];
            _loading = false;
        }
    }

    private async Task LoadCategories()
    {
        var result = await ProductService.GetCategoriesAsync();
        if (result.IsSuccess && result.Value is not null)
        {
            _categories = result.Value;
        }
    }

    private async Task LoadProduct(Guid id)
    {
        try
        {
            var result = await ProductService.GetProductByIdAsync(id);
            if (result.IsSuccess && result.Value is not null)
            {
                var dto = result.Value;
                _product = new CreateProductRequest
                {
                    Sku = dto.Sku,
                    Barcode = dto.Barcode,
                    BarcodeType = dto.BarcodeType,
                    Name = dto.Name,
                    Description = dto.Description,
                    ShortDescription = dto.ShortDescription,
                    CategoryId = dto.CategoryId,
                    Brand = dto.Brand,
                    Manufacturer = dto.Manufacturer,
                    ModelNumber = dto.ModelNumber,
                    CostPrice = dto.CostPrice,
                    SalePrice = dto.SalePrice,
                    WholesalePrice = dto.WholesalePrice,
                    Msrp = dto.Msrp,
                    TaxRate = dto.TaxRate,
                    IsTaxExempt = dto.IsTaxExempt,
                    TrackInventory = dto.TrackInventory,
                    UnitOfMeasure = dto.UnitOfMeasure,
                    MinStockLevel = dto.MinStockLevel,
                    MaxStockLevel = dto.MaxStockLevel,
                    ReorderPoint = dto.ReorderPoint,
                    ReorderQuantity = dto.ReorderQuantity,
                    WeightKg = dto.WeightKg,
                    LengthCm = dto.LengthCm,
                    WidthCm = dto.WidthCm,
                    HeightCm = dto.HeightCm,
                    SatProductCode = dto.SatProductCode,
                    SatUnitCode = dto.SatUnitCode,
                    SatHazardousMaterial = dto.SatHazardousMaterial,
                    PrimaryImageUrl = dto.PrimaryImageUrl,
                    IsService = dto.IsService,
                    IsBundle = dto.IsBundle,
                    IsActive = dto.IsActive,
                    IsFeatured = dto.IsFeatured,
                    Slug = dto.Slug,
                    MetaTitle = dto.MetaTitle,
                    MetaDescription = dto.MetaDescription,
                    MetaKeywords = dto.MetaKeywords
                };
            }
            else
            {
                _errorMessage = result.Error ?? L["ProductNotFound"];
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"{L["Error"]}: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleSubmit()
    {
        _saving = true;
        _errorMessage = null;

        try
        {
            if (_isEditMode && Id.HasValue)
            {
                var updateRequest = new UpdateProductRequest
                {
                    Id = Id.Value,
                    Sku = _product.Sku,
                    Barcode = _product.Barcode,
                    BarcodeType = _product.BarcodeType,
                    Name = _product.Name,
                    Description = _product.Description,
                    ShortDescription = _product.ShortDescription,
                    CategoryId = _product.CategoryId,
                    Brand = _product.Brand,
                    Manufacturer = _product.Manufacturer,
                    ModelNumber = _product.ModelNumber,
                    CostPrice = _product.CostPrice,
                    SalePrice = _product.SalePrice,
                    WholesalePrice = _product.WholesalePrice,
                    Msrp = _product.Msrp,
                    TaxRate = _product.TaxRate,
                    IsTaxExempt = _product.IsTaxExempt,
                    TrackInventory = _product.TrackInventory,
                    UnitOfMeasure = _product.UnitOfMeasure,
                    MinStockLevel = _product.MinStockLevel,
                    MaxStockLevel = _product.MaxStockLevel,
                    ReorderPoint = _product.ReorderPoint,
                    ReorderQuantity = _product.ReorderQuantity,
                    WeightKg = _product.WeightKg,
                    LengthCm = _product.LengthCm,
                    WidthCm = _product.WidthCm,
                    HeightCm = _product.HeightCm,
                    SatProductCode = _product.SatProductCode,
                    SatUnitCode = _product.SatUnitCode,
                    SatHazardousMaterial = _product.SatHazardousMaterial,
                    PrimaryImageUrl = _product.PrimaryImageUrl,
                    IsService = _product.IsService,
                    IsBundle = _product.IsBundle,
                    IsActive = _product.IsActive,
                    IsFeatured = _product.IsFeatured,
                    Slug = _product.Slug,
                    MetaTitle = _product.MetaTitle,
                    MetaDescription = _product.MetaDescription,
                    MetaKeywords = _product.MetaKeywords
                };

                var result = await ProductService.UpdateProductAsync(updateRequest);
                if (result.IsSuccess)
                {
                    Snackbar.Add(L["ProductUpdatedSuccessfully"], Severity.Success);
                    NavigationManager.NavigateTo("/products");
                }
                else
                {
                    _errorMessage = result.Error ?? L["UnexpectedError"];
                }
            }
            else
            {
                var result = await ProductService.CreateProductAsync(_product);
                if (result.IsSuccess)
                {
                    Snackbar.Add(L["ProductCreatedSuccessfully"], Severity.Success);
                    NavigationManager.NavigateTo("/products");
                }
                else
                {
                    _errorMessage = result.Error ?? L["UnexpectedError"];
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"{L["Error"]}: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }
}
