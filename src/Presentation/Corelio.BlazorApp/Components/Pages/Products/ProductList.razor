@page "/products"
@using System.Globalization
@using Corelio.BlazorApp.Components.Shared
@inject IProductService ProductService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L
@inject IDialogService DialogService

<PageTitle>@L["ProductList"] - Corelio</PageTitle>

<AuthorizeView Context="authContext">
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-6">
        <!-- Page Header with Breadcrumbs -->
        <PageHeader Title="@L["Products"]"
                    Description="@L["ProductListDescription"]"
                    Breadcrumbs="@_breadcrumbs">
            <Actions>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@(() => NavigationManager.NavigateTo("/products/new"))">
                    @L["AddProduct"]
                </MudButton>
            </Actions>
        </PageHeader>

        <!-- Search and Filters -->
        <ProductFilterBar Categories="_categories"
                          ShowStatusFilter="true"
                          OnSearch="OnFilterSearch" />

        <!-- Products Table -->
        @if (_loading)
        {
            <LoadingState Message="@L["Loading"]" />
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }
        else if (_products is not null && _products.Any())
        {
                <MudTable Items="@_products" Hover="true" Dense="true" Striped="true">
                    <HeaderContent>
                        <MudTh>@L["SKU"]</MudTh>
                        <MudTh>@L["ProductName"]</MudTh>
                        <MudTh>@L["Category"]</MudTh>
                        <MudTh Style="text-align: right;">@L["SalePrice"]</MudTh>
                        <MudTh Style="text-align: right;">@L["CostPrice"]</MudTh>
                        <MudTh Style="text-align: center;">@L["Active"]</MudTh>
                        <MudTh Style="text-align: center;">@L["Actions"]</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="SKU">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                @if (!string.IsNullOrEmpty(context.PrimaryImageUrl))
                                {
                                    <MudImage Src="@context.PrimaryImageUrl" Alt="@context.Name" Width="40" Height="40" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                }
                                <MudText>@context.Sku</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="@L["ProductName"]">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                                @if (!string.IsNullOrEmpty(context.Brand))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Brand</MudText>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="@L["Category"]">@context.CategoryName</MudTd>
                        <MudTd DataLabel="@L["SalePrice"]" Style="text-align: right;">
                            @context.SalePrice.ToString("C", new CultureInfo("es-MX"))
                        </MudTd>
                        <MudTd DataLabel="@L["CostPrice"]" Style="text-align: right;">
                            @context.CostPrice.ToString("C", new CultureInfo("es-MX"))
                        </MudTd>
                        <MudTd DataLabel="@L["Active"]" Style="text-align: center;">
                            @if (context.IsActive)
                            {
                                <MudBadge Color="Color.Success" Dot="true">@L["Active"]</MudBadge>
                            }
                            else
                            {
                                <MudBadge Color="Color.Default" Dot="true">@L["Inactive"]</MudBadge>
                            }
                        </MudTd>
                        <MudTd DataLabel="@L["Actions"]" Style="text-align: center;">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => NavigationManager.NavigateTo($"/products/{context.Id}"))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteProduct(context.Id))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <!-- Pagination -->
                @if (_pagedResult is not null)
                {
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">
                            Mostrando @_pagedResult.Items.Count de @_pagedResult.TotalCount @L["Products"]
                        </MudText>
                        <MudPagination Count="@_pagedResult.TotalPages"
                                       Selected="@_pagedResult.PageNumber"
                                       SelectedChanged="@(async (page) => { _currentPage = page; await LoadProducts(); })"
                                       BoundaryCount="1"
                                       MiddleCount="3"
                                       Color="Color.Primary" />
                    </MudStack>
                }
            }
            else
            {
                <EmptyState Icon="@Icons.Material.Filled.Inventory2"
                            Title="@L["NoProductsFound"]"
                            Description="@L["NoProductsDescription"]"
                            ActionText="@L["AddProduct"]"
                            ActionIcon="@Icons.Material.Filled.Add"
                            OnAction="@(() => NavigationManager.NavigateTo("/products/new"))" />
            }
    </MudPaper>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool _loading = true;
    private string? _errorMessage;
    private List<ProductListDto> _products = [];
    private List<ProductCategoryDto> _categories = [];
    private PagedResult<ProductListDto>? _pagedResult;

    // Filters
    private ProductFilterCriteria _filterCriteria = new(null, null, null);
    private int _currentPage = 1;
    private int _pageSize = 20;

    // Breadcrumbs
    private List<BreadcrumbItem> _breadcrumbs = [];

    protected override async Task OnInitializedAsync()
    {
        _breadcrumbs =
        [
            new BreadcrumbItem(L["Home"], "/"),
            new BreadcrumbItem(L["Products"], null, disabled: true)
        ];

        await LoadCategories();
        await LoadProducts();
    }

    private async Task LoadCategories()
    {
        var result = await ProductService.GetCategoriesAsync();
        if (result.IsSuccess && result.Value is not null)
        {
            _categories = result.Value;
        }
    }

    private async Task OnFilterSearch(ProductFilterCriteria criteria)
    {
        _filterCriteria = criteria;
        _currentPage = 1;
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var result = await ProductService.GetProductsAsync(
                _currentPage,
                _pageSize,
                _filterCriteria.SearchTerm,
                _filterCriteria.CategoryId,
                _filterCriteria.IsActive);

            if (result.IsSuccess && result.Value is not null)
            {
                _pagedResult = result.Value;
                _products = _pagedResult.Items;
            }
            else
            {
                _errorMessage = result.Error ?? L["ErrorLoadingProducts"];
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"{L["Error"]}: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task DeleteProduct(Guid productId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            L["DeleteProduct"],
            L["DeleteProductConfirmation"],
            yesText: L["Delete"], cancelText: L["Cancel"]);

        if (confirmed == true)
        {
            var result = await ProductService.DeleteProductAsync(productId);
            if (result.IsSuccess)
            {
                await LoadProducts();
            }
            else
            {
                _errorMessage = result.Error ?? L["UnexpectedError"];
            }
        }
    }
}
