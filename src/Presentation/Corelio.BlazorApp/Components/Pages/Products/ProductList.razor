@page "/products"
@using System.Globalization
@attribute [Authorize]
@inject IProductService ProductService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L
@inject IDialogService DialogService

<PageTitle>@L["ProductList"] - Corelio</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-4">
        <MudStack Spacing="4">
            <!-- Header -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4">@L["Products"]</MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@(() => NavigationManager.NavigateTo("/products/new"))">
                    @L["AddProduct"]
                </MudButton>
            </MudStack>

            <!-- Search and Filters -->
            <MudStack Row="true" Spacing="2">
                <MudTextField @bind-Value="_searchTerm"
                              Label="@L["Search"]"
                              Placeholder="@L["SearchProducts"]"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              OnAdornmentClick="LoadProducts"
                              OnKeyUp="@(async (e) => { if (e.Key == "Enter") await LoadProducts(); })"
                              Class="flex-grow-1" />

                <MudSelect @bind-Value="_selectedCategoryId"
                           Label="@L["Category"]"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           Style="min-width: 200px;">
                    @foreach (var category in _categories)
                    {
                        <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="_isActiveFilter"
                           Label="@L["Active"]"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           Style="min-width: 150px;">
                    <MudSelectItem Value="@true">@L["Active"]</MudSelectItem>
                    <MudSelectItem Value="@false">@L["Inactive"]</MudSelectItem>
                </MudSelect>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="LoadProducts">
                    @L["Search"]
                </MudButton>
            </MudStack>

            <!-- Products Table -->
            @if (_loading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }
            else if (_products is not null && _products.Any())
            {
                <MudTable Items="@_products" Hover="true" Dense="true" Striped="true">
                    <HeaderContent>
                        <MudTh>@L["SKU"]</MudTh>
                        <MudTh>@L["ProductName"]</MudTh>
                        <MudTh>@L["Category"]</MudTh>
                        <MudTh Style="text-align: right;">@L["SalePrice"]</MudTh>
                        <MudTh Style="text-align: right;">@L["CostPrice"]</MudTh>
                        <MudTh Style="text-align: center;">@L["Active"]</MudTh>
                        <MudTh Style="text-align: center;">@L["Actions"]</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="SKU">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                @if (!string.IsNullOrEmpty(context.PrimaryImageUrl))
                                {
                                    <MudImage Src="@context.PrimaryImageUrl" Alt="@context.Name" Width="40" Height="40" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                }
                                <MudText>@context.Sku</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="@L["ProductName"]">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                                @if (!string.IsNullOrEmpty(context.Brand))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Brand</MudText>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="@L["Category"]">@context.CategoryName</MudTd>
                        <MudTd DataLabel="@L["SalePrice"]" Style="text-align: right;">
                            @context.SalePrice.ToString("C", new CultureInfo("es-MX"))
                        </MudTd>
                        <MudTd DataLabel="@L["CostPrice"]" Style="text-align: right;">
                            @context.CostPrice.ToString("C", new CultureInfo("es-MX"))
                        </MudTd>
                        <MudTd DataLabel="@L["Active"]" Style="text-align: center;">
                            @if (context.IsActive)
                            {
                                <MudBadge Color="Color.Success" Dot="true">@L["Active"]</MudBadge>
                            }
                            else
                            {
                                <MudBadge Color="Color.Default" Dot="true">@L["Inactive"]</MudBadge>
                            }
                        </MudTd>
                        <MudTd DataLabel="@L["Actions"]" Style="text-align: center;">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => NavigationManager.NavigateTo($"/products/{context.Id}"))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteProduct(context.Id))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <!-- Pagination -->
                @if (_pagedResult is not null)
                {
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">
                            Mostrando @_pagedResult.Items.Count de @_pagedResult.TotalCount @L["Products"]
                        </MudText>
                        <MudPagination Count="@_pagedResult.TotalPages"
                                       Selected="@_pagedResult.PageNumber"
                                       SelectedChanged="@(async (page) => { _currentPage = page; await LoadProducts(); })"
                                       BoundaryCount="1"
                                       MiddleCount="3"
                                       Color="Color.Primary" />
                    </MudStack>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Info">@L["NoProductsFound"]</MudAlert>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private bool _loading = true;
    private string? _errorMessage;
    private List<ProductListDto> _products = [];
    private List<ProductCategoryDto> _categories = [];
    private PagedResult<ProductListDto>? _pagedResult;

    // Filters
    private string? _searchTerm;
    private Guid? _selectedCategoryId;
    private bool? _isActiveFilter;
    private int _currentPage = 1;
    private int _pageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadProducts();
    }

    private async Task LoadCategories()
    {
        var result = await ProductService.GetCategoriesAsync();
        if (result.IsSuccess && result.Value is not null)
        {
            _categories = result.Value;
        }
    }

    private async Task LoadProducts()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var result = await ProductService.GetProductsAsync(
                _currentPage,
                _pageSize,
                _searchTerm,
                _selectedCategoryId,
                _isActiveFilter);

            if (result.IsSuccess && result.Value is not null)
            {
                _pagedResult = result.Value;
                _products = _pagedResult.Items;
            }
            else
            {
                _errorMessage = result.Error ?? L["ErrorLoadingProducts"];
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"{L["Error"]}: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task DeleteProduct(Guid productId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            L["DeleteProduct"],
            L["DeleteProductConfirmation"],
            yesText: L["Delete"], cancelText: L["Cancel"]);

        if (confirmed == true)
        {
            var result = await ProductService.DeleteProductAsync(productId);
            if (result.IsSuccess)
            {
                await LoadProducts();
            }
            else
            {
                _errorMessage = result.Error ?? L["UnexpectedError"];
            }
        }
    }
}
