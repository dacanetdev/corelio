@page "/auth/login"
@layout AuthLayout
@rendermode InteractiveServer
@using Corelio.BlazorApp.Models.Authentication
@using Corelio.BlazorApp.Models.ViewModels
@using Corelio.BlazorApp.Resources
@using Microsoft.Extensions.Localization
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L

<PageTitle>@L["LoginPageTitle"]</PageTitle>

<div class="auth-hero">
    <div class="auth-icon-circle">
        <MudIcon Icon="@Icons.Material.Filled.Store" />
    </div>
    <div class="auth-title">@L["AppTitle"]</div>
    <MudText Typo="Typo.body1" Class="auth-subtitle">
        @L["AppSubtitle"]
    </MudText>
</div>

<MudPaper Class="auth-card" Elevation="8">
    @if (_sessionExpired)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Warning" Class="mb-4">
            @L["SessionExpired"]
        </MudAlert>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Error" Class="mb-4">
            @_errorMessage
        </MudAlert>
    }

    <EditForm Model="LoginModel!" OnValidSubmit="HandleLogin" FormName="loginForm">
        <DataAnnotationsValidator />

        <MudTextField @bind-Value="LoginModel!.Email"
                      Label="@L["Email"]"
                      Variant="Variant.Outlined"
                      InputType="InputType.Email"
                      Required="true"
                      HelperText="@L["EmailHelperText"]"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Email"
                      Class="mb-4"
                      For="@(() => LoginModel!.Email)" />

        <MudTextField @bind-Value="LoginModel!.Password"
                      Label="@L["Password"]"
                      Variant="Variant.Outlined"
                      InputType="@_passwordInputType"
                      Required="true"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                      OnAdornmentClick="TogglePasswordVisibility"
                      Class="mb-6"
                      For="@(() => LoginModel!.Password)" />

        <MudButton ButtonType="ButtonType.Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   Class="auth-submit-button mb-4"
                   Disabled="_isLoading">
            @if (_isLoading)
            {
                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                <MudText>@L["LoadingText"]</MudText>
            }
            else
            {
                @L["Login"]
            }
        </MudButton>

        <MudText Align="Align.Center" Class="mb-6">
            <MudLink Href="/auth/forgot-password" Class="auth-link">
                @L["ForgotPassword"]
            </MudLink>
        </MudText>

        <MudDivider Class="my-6" />

        <MudStack AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @L["NoAccount"]
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @L["ContactAdministrator"]
            </MudText>
        </MudStack>
    </EditForm>
</MudPaper>

@code {
    [SupplyParameterFromForm]
    private LoginViewModel? LoginModel { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private bool _sessionExpired;
    private bool _showPassword;
    private InputType _passwordInputType = InputType.Password;

    [SupplyParameterFromQuery(Name = "expired")]
    public bool SessionExpired { get; set; }

    protected override void OnInitialized()
    {
        LoginModel ??= new();
        _sessionExpired = SessionExpired;
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInputType = _showPassword ? InputType.Text : InputType.Password;
    }

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var request = new LoginRequest
            {
                Email = LoginModel!.Email,
                Password = LoginModel!.Password
            };

            var result = await AuthService.LoginAsync(request);

            if (result.IsSuccess)
            {
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                _errorMessage = L["LoginFailed"];
            }
        }
        catch (Exception)
        {
            _errorMessage = L["UnexpectedError"];
        }
        finally
        {
            _isLoading = false;
        }
    }
}
