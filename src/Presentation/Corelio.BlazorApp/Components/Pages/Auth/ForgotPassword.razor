@page "/auth/forgot-password"
@layout AuthLayout
@rendermode InteractiveServer
@using Corelio.BlazorApp.Models.Authentication
@using Corelio.BlazorApp.Models.ViewModels
@using Corelio.BlazorApp.Resources
@using Microsoft.Extensions.Localization
@inject IAuthService AuthService
@inject IStringLocalizer<SharedResource> L

<PageTitle>@L["ForgotPasswordPageTitle"]</PageTitle>

<div class="auth-hero">
    <div class="auth-icon-circle">
        <MudIcon Icon="@Icons.Material.Filled.Email" />
    </div>
    <div class="auth-title">@L["ForgotPasswordTitle"]</div>
    <MudText Typo="Typo.body1" Class="auth-subtitle">
        @L["ForgotPasswordDescription"]
    </MudText>
</div>

<MudPaper Class="auth-card" Elevation="8">
    @if (_successMessage)
    {
        <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Icon="@Icons.Material.Filled.CheckCircle" Class="mb-4">
            @L["PasswordResetEmailSent"]
        </MudAlert>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Error" Class="mb-4">
            @_errorMessage
        </MudAlert>
    }

    @if (!_successMessage)
    {
        <EditForm Model="ForgotPasswordModel!" OnValidSubmit="HandleForgotPassword" FormName="forgotPasswordForm">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="ForgotPasswordModel!.Email"
                          Label="@L["Email"]"
                          Variant="Variant.Outlined"
                          InputType="InputType.Email"
                          Required="true"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Email"
                          Class="mb-6"
                          For="@(() => ForgotPasswordModel!.Email)" />

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="auth-submit-button mb-4"
                       Disabled="_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    <MudText>@L["LoadingText"]</MudText>
                }
                else
                {
                    @L["SendInstructions"]
                }
            </MudButton>

            <MudText Align="Align.Center">
                <MudLink Href="/auth/login" Class="auth-link">
                    @L["BackToLogin"]
                </MudLink>
            </MudText>
        </EditForm>
    }
    else
    {
        <MudText Align="Align.Center" Class="mt-4">
            <MudLink Href="/auth/login" Class="auth-link">
                @L["BackToLogin"]
            </MudLink>
        </MudText>
    }
</MudPaper>

@code {
    [SupplyParameterFromForm]
    private ForgotPasswordViewModel? ForgotPasswordModel { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private bool _successMessage;

    protected override void OnInitialized()
    {
        ForgotPasswordModel ??= new();
    }

    private async Task HandleForgotPassword()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var request = new ForgotPasswordRequest
            {
                Email = ForgotPasswordModel!.Email
            };

            var result = await AuthService.ForgotPasswordAsync(request);

            // Always show success message (security best practice)
            _successMessage = true;
        }
        catch (Exception)
        {
            _errorMessage = L["UnexpectedError"];
        }
        finally
        {
            _isLoading = false;
        }
    }
}
