@page "/auth/register"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "users.create")]
@using Corelio.BlazorApp.Models.Authentication
@using Corelio.BlazorApp.Models.ViewModels
@using Corelio.BlazorApp.Resources
@using Microsoft.Extensions.Localization
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L

<PageTitle>@L["RegisterPageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
            @L["Register"]
        </MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                @_errorMessage
            </MudAlert>
        }

        @if (_successMessage)
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">
                @L["RegistrationSuccess"]
            </MudAlert>
        }

        <EditForm Model="RegisterModel!" OnValidSubmit="HandleRegister" FormName="registerForm">
            <DataAnnotationsValidator />

            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="RegisterModel!.FirstName"
                                  Label="@L["FirstName"]"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  For="@(() => RegisterModel!.FirstName)" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="RegisterModel!.LastName"
                                  Label="@L["LastName"]"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  For="@(() => RegisterModel!.LastName)" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="RegisterModel!.Email"
                                  Label="@L["Email"]"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  For="@(() => RegisterModel!.Email)" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="RegisterModel!.Password"
                                  Label="@L["Password"]"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  For="@(() => RegisterModel!.Password)" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="RegisterModel!.ConfirmPassword"
                                  Label="@L["ConfirmPassword"]"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  For="@(() => RegisterModel!.ConfirmPassword)" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Size="Size.Large"
                               Disabled="_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">@L["Register"]...</MudText>
                        }
                        else
                        {
                            @L["Register"]
                        }
                    </MudButton>
                </MudItem>

                <MudItem xs="12">
                    <MudText Align="Align.Center">
                        <MudLink Href="/auth/login" Color="Color.Primary">
                            @L["BackToLogin"]
                        </MudLink>
                    </MudText>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromForm]
    private RegisterViewModel? RegisterModel { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private bool _successMessage;

    protected override void OnInitialized()
    {
        RegisterModel ??= new();
    }

    private async Task HandleRegister()
    {
        _isLoading = true;
        _errorMessage = null;
        _successMessage = false;

        try
        {
            var request = new RegisterRequest
            {
                Email = RegisterModel!.Email,
                Password = RegisterModel!.Password,
                ConfirmPassword = RegisterModel!.ConfirmPassword,
                FirstName = RegisterModel!.FirstName,
                LastName = RegisterModel!.LastName,
                Roles = RegisterModel!.Roles
            };

            var result = await AuthService.RegisterAsync(request);

            if (result.IsSuccess)
            {
                _successMessage = true;
                RegisterModel = new(); // Reset form

                // Redirect to login after 2 seconds
                await Task.Delay(2000);
                NavigationManager.NavigateTo("/auth/login");
            }
            else
            {
                _errorMessage = result.Error ?? L["RegistrationFailed"];
            }
        }
        catch (Exception)
        {
            _errorMessage = L["UnexpectedError"];
        }
        finally
        {
            _isLoading = false;
        }
    }
}
