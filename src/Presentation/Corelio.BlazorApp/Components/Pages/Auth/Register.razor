@page "/auth/register"
@layout AuthLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Corelio.BlazorApp.Models.Authentication
@using Corelio.BlazorApp.Models.ViewModels
@using Corelio.BlazorApp.Resources
@using Microsoft.Extensions.Localization
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L

<PageTitle>@L["RegisterPageTitle"]</PageTitle>

<AuthorizeView Policy="users.create" Context="authContext">
    <Authorized>
        <div class="auth-hero">
    <div class="auth-icon-circle">
        <MudIcon Icon="@Icons.Material.Filled.Store" />
    </div>
    <div class="auth-title">@L["AppTitle"]</div>
    <MudText Typo="Typo.body1" Class="auth-subtitle">
        @L["AppSubtitle"]
    </MudText>
</div>

<MudPaper Class="auth-card" Elevation="8">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-6">
        <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" Size="Size.Large" />
        <MudText Typo="Typo.h4" Color="Color.Primary">
            @L["RegisterUser"]
        </MudText>
    </MudStack>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Error" Class="mb-4">
            @_errorMessage
        </MudAlert>
    }

    @if (_successMessage)
    {
        <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Icon="@Icons.Material.Filled.CheckCircle" Class="mb-4">
            @L["RegistrationSuccess"]
            <MudText Typo="Typo.body2" Class="mt-2">
                @L["RedirectingToLogin"]
            </MudText>
        </MudAlert>
    }

    <EditForm Model="RegisterModel!" OnValidSubmit="HandleRegister" FormName="registerForm">
        <DataAnnotationsValidator />

        <MudText Typo="Typo.h6" Class="auth-section-header">
            @L["PersonalInformation"]
        </MudText>

        <MudGrid Spacing="4">
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="RegisterModel!.FirstName"
                              Label="@L["FirstName"]"
                              Variant="Variant.Outlined"
                              Required="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person"
                              For="@(() => RegisterModel!.FirstName)" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="RegisterModel!.LastName"
                              Label="@L["LastName"]"
                              Variant="Variant.Outlined"
                              Required="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person"
                              For="@(() => RegisterModel!.LastName)" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="RegisterModel!.Email"
                              Label="@L["Email"]"
                              Variant="Variant.Outlined"
                              InputType="InputType.Email"
                              Required="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              For="@(() => RegisterModel!.Email)" />
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-6" />

        <MudText Typo="Typo.h6" Class="auth-section-header">
            @L["SecuritySection"]
        </MudText>

        <MudGrid Spacing="4">
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="RegisterModel!.Password"
                              Label="@L["Password"]"
                              Variant="Variant.Outlined"
                              InputType="@_passwordInputType"
                              Required="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="TogglePasswordVisibility"
                              For="@(() => RegisterModel!.Password)" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="RegisterModel!.ConfirmPassword"
                              Label="@L["ConfirmPassword"]"
                              Variant="Variant.Outlined"
                              InputType="@_confirmPasswordInputType"
                              Required="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="ToggleConfirmPasswordVisibility"
                              For="@(() => RegisterModel!.ConfirmPassword)" />
            </MudItem>
        </MudGrid>

        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd" Spacing="3" Class="mt-6">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="@(() => NavigationManager.NavigateTo("/auth/login"))"
                       Disabled="_isLoading">
                @L["Cancel"]
            </MudButton>

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       Style="min-width: 160px;"
                       Disabled="_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    <MudText>@L["LoadingText"]</MudText>
                }
                else
                {
                    @L["Register"]
                }
            </MudButton>
        </MudStack>
    </EditForm>
</MudPaper>
    </Authorized>
    <NotAuthorized>
        <MudPaper Class="auth-card" Elevation="8">
            <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Lock">
                @L["UnauthorizedAccess"]
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/" Class="mt-4">
                @L["BackToHome"]
            </MudButton>
        </MudPaper>
    </NotAuthorized>
</AuthorizeView>

@code {
    [SupplyParameterFromForm]
    private RegisterViewModel? RegisterModel { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private bool _successMessage;
    private bool _showPassword;
    private bool _showConfirmPassword;
    private InputType _passwordInputType = InputType.Password;
    private InputType _confirmPasswordInputType = InputType.Password;

    protected override void OnInitialized()
    {
        RegisterModel ??= new();
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInputType = _showPassword ? InputType.Text : InputType.Password;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        _showConfirmPassword = !_showConfirmPassword;
        _confirmPasswordInputType = _showConfirmPassword ? InputType.Text : InputType.Password;
    }

    private async Task HandleRegister()
    {
        _isLoading = true;
        _errorMessage = null;
        _successMessage = false;

        try
        {
            var request = new RegisterRequest
            {
                Email = RegisterModel!.Email,
                Password = RegisterModel!.Password,
                ConfirmPassword = RegisterModel!.ConfirmPassword,
                FirstName = RegisterModel!.FirstName,
                LastName = RegisterModel!.LastName,
                Roles = RegisterModel!.Roles
            };

            var result = await AuthService.RegisterAsync(request);

            if (result.IsSuccess)
            {
                _successMessage = true;
                StateHasChanged();

                // Redirect to login after 2 seconds
                await Task.Delay(2000);
                NavigationManager.NavigateTo("/auth/login");
            }
            else
            {
                _errorMessage = result.Error ?? L["RegistrationFailed"];
            }
        }
        catch (Exception)
        {
            _errorMessage = L["UnexpectedError"];
        }
        finally
        {
            _isLoading = false;
        }
    }
}
