@using Corelio.BlazorApp.Resources
@using Microsoft.Extensions.Localization
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> L

<AuthorizeView>
    <Authorized>
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Dense="true">
            <ActivatorContent>
                <div class="user-display-activator">
                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="user-display-avatar">
                        @_initials
                    </MudAvatar>
                    <div class="user-display-info">
                        <span class="user-display-name">@_userInfo?.FullName</span>
                        <span class="user-display-email">@_userInfo?.Email</span>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" Class="user-display-dropdown-icon" />
                </div>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Icon="@Icons.Material.Filled.Person" OnClick="@(() => NavigateToProfile())">
                    @L["MyProfile"]
                </MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="@(() => NavigateToSettings())">
                    @L["Settings"]
                </MudMenuItem>
                <MudDivider Class="my-2" />
                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogout" Class="user-display-logout">
                    @L["Logout"]
                </MudMenuItem>
            </ChildContent>
        </MudMenu>
    </Authorized>
    <NotAuthorized>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/auth/login" StartIcon="@Icons.Material.Filled.Login" Size="Size.Small">
            @L["Login"]
        </MudButton>
    </NotAuthorized>
</AuthorizeView>

@code {
    private Models.Authentication.UserInfo? _userInfo;
    private string _initials = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _userInfo = await AuthService.GetCurrentUserAsync();
        if (_userInfo is not null)
        {
            _initials = GetInitials(_userInfo.FullName);
        }
    }

    private static string GetInitials(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "?";

        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length switch
        {
            0 => "?",
            1 => parts[0][..1].ToUpperInvariant(),
            _ => $"{parts[0][..1]}{parts[^1][..1]}".ToUpperInvariant()
        };
    }

    private void NavigateToProfile()
    {
        NavigationManager.NavigateTo("/profile");
    }

    private void NavigateToSettings()
    {
        NavigationManager.NavigateTo("/settings");
    }

    private void HandleLogout()
    {
        NavigationManager.NavigateTo("/auth/logout");
    }
}
