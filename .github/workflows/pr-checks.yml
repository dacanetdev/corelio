name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title format
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        # Enforce conventional commits format
        if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .+'; then
          echo "âŒ PR title does not follow conventional commits format"
          echo "Expected format: type(scope): description"
          echo "Examples: feat(pos): add barcode scanning, fix(auth): correct JWT expiration"
          exit 1
        fi
        echo "âœ… PR title follows conventional commits format"

    - name: Check for breaking changes
      run: |
        if git log --format=%B ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -q "BREAKING CHANGE"; then
          echo "âš ï¸ This PR contains breaking changes"
          echo "Please ensure version is bumped and migration guide is provided"
        fi

    - name: Check file changes
      run: |
        # Fail if too many files changed (possible accidental commit)
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
        if [ "$CHANGED_FILES" -gt 100 ]; then
          echo "âš ï¸ This PR changes $CHANGED_FILES files. Are you sure this is intentional?"
          echo "Consider breaking this into smaller PRs"
        fi

  build-pr:
    name: Build PR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install .NET Aspire workload
      run: |
        dotnet workload update
        dotnet workload install aspire

    - name: Restore and build
      run: |
        dotnet restore
        dotnet build --no-restore --configuration Release

  test-pr:
    name: Test PR
    runs-on: ubuntu-latest
    needs: build-pr

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install .NET Aspire workload
      run: |
        dotnet workload update
        dotnet workload install aspire

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Run all tests
      run: |
        dotnet test \
          --no-build \
          --configuration Release \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults

    - name: Comment test results on PR
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: './TestResults/**/*.trx'
        reporter: dotnet-trx
        fail-on-error: true

  multi-tenancy-check:
    name: Multi-Tenancy Security Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for ITenantEntity implementation
      run: |
        echo "ðŸ” Checking for proper multi-tenancy implementation..."

        # Check if new entities implement ITenantEntity
        NEW_ENTITIES=$(git diff --diff-filter=A origin/main...HEAD --name-only | grep -E "Domain/Entities/.*\.cs$" || true)

        if [ -n "$NEW_ENTITIES" ]; then
          for file in $NEW_ENTITIES; do
            if ! grep -q "ITenantEntity" "$file"; then
              echo "âš ï¸ Warning: $file may need to implement ITenantEntity"
            fi
          done
        fi

    - name: Check for tenant_id in queries
      run: |
        echo "ðŸ” Checking for potential tenant isolation issues..."

        # Look for queries that might bypass tenant filter
        if git diff origin/main...HEAD | grep -E "\.IgnoreQueryFilters\(\)" | grep -v "// SAFE:"; then
          echo "âš ï¸ Warning: Found IgnoreQueryFilters() without SAFE comment"
          echo "Please ensure this is intentional and document why it's safe"
        fi

  code-review-checklist:
    name: Code Review Checklist
    runs-on: ubuntu-latest

    steps:
    - name: Post review checklist
      uses: actions/github-script@v7
      with:
        script: |
          const checklist = `
          ## Code Review Checklist

          ### Architecture
          - [ ] Follows Clean Architecture principles
          - [ ] Domain layer has zero dependencies
          - [ ] CQRS pattern used correctly (MediatR)
          - [ ] Proper separation of concerns

          ### Multi-Tenancy
          - [ ] All business entities implement ITenantEntity
          - [ ] No tenant_id accepted from client input
          - [ ] Query filters applied correctly
          - [ ] Tenant isolation tests included

          ### Security
          - [ ] No SQL injection vulnerabilities
          - [ ] No XSS vulnerabilities
          - [ ] No hardcoded secrets
          - [ ] Proper authorization checks
          - [ ] Sensitive data encrypted

          ### Code Quality
          - [ ] Uses C# 14 features (primary constructors, collection expressions)
          - [ ] File-scoped namespaces used
          - [ ] XML documentation for public methods
          - [ ] No magic strings or numbers
          - [ ] Proper error handling

          ### Testing
          - [ ] Unit tests for new/modified business logic
          - [ ] Integration tests for API endpoints
          - [ ] Multi-tenancy isolation tests
          - [ ] Code coverage >70%

          ### Performance
          - [ ] Database queries optimized (indexes, AsNoTracking)
          - [ ] No N+1 query problems
          - [ ] Proper caching where applicable
          - [ ] Meets performance targets

          ### Documentation
          - [ ] README updated if needed
          - [ ] API documentation updated (Swagger)
          - [ ] Migration guide for breaking changes
          - [ ] Comments explain WHY, not WHAT
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: checklist
          });

  size-label:
    name: PR Size Labeling
    runs-on: ubuntu-latest

    steps:
    - name: Label PR by size
      uses: codelytv/pr-size-labeler@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        xs_label: 'size/xs'
        xs_max_size: 10
        s_label: 'size/s'
        s_max_size: 100
        m_label: 'size/m'
        m_max_size: 500
        l_label: 'size/l'
        l_max_size: 1000
        xl_label: 'size/xl'
        fail_if_xl: false
